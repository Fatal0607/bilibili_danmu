<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B站直播弹幕获取器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background-color: #00a1d6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0085b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .danmu-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fafafa;
            border-radius: 4px;
        }
        .danmu-item {
            margin-bottom: 8px;
            padding: 5px;
            background-color: white;
            border-radius: 3px;
            border-left: 3px solid #00a1d6;
        }
        .danmu-user {
            font-weight: bold;
            color: #00a1d6;
        }
        .danmu-content {
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>B站直播弹幕获取器</h1>
        
        <div class="input-group">
            <label for="roomId">房间号:</label>
            <input type="text" id="roomId" placeholder="请输入直播间房间号" value="923833" />
        </div>
        
        <button id="connectBtn" onclick="connectToRoom()">连接直播间</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>断开连接</button>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <h3>弹幕消息:</h3>
        <div id="danmuContainer" class="danmu-container"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script>
        let ws = null;
        let heartbeatInterval = null;

        // 弹幕提取器类
        class DanmuExtractor {
            constructor() {
                this.callbacks = {};
            }

            on(event, callback) {
                if (!this.callbacks[event]) {
                    this.callbacks[event] = [];
                }
                this.callbacks[event].push(callback);
            }

            emit(event, data) {
                if (this.callbacks[event]) {
                    this.callbacks[event].forEach(callback => callback(data));
                }
            }

            getDmMsg(data) {
                // 获取数据包长度，协议类型和操作类型
                const packetLen = this.readUInt32BE(data, 0);
                const proto = this.readUInt16BE(data, 6);
                const op = this.readUInt32BE(data, 8);

                // 若数据包是连着的，则根据第一个数据包的长度进行切分
                if (data.byteLength > packetLen) {
                    this.getDmMsg(data.slice(packetLen));
                    data = data.slice(0, packetLen);
                }

                // 判断协议类型，若为 2 则用 pako 解压
                if (proto === 2) {
                    try {
                        const decompressed = pako.inflate(data.slice(16));
                        this.getDmMsg(decompressed.buffer);
                        return;
                    } catch (e) {
                        console.error('解压失败:', e);
                        return;
                    }
                }

                if (op === 3) {
                    console.info("HeartBeat");
                }

                // 判断消息类型
                if (op === 5) {
                    try {
                        // 解析 json
                        const content = JSON.parse(new TextDecoder().decode(data.slice(16)));
                        // 发送数据
                        this.emit('MsgData', content);
                    } catch (e) {
                        console.error(`[GETDATA ERROR]: ${e}`);
                    }
                }
            }

            readUInt32BE(buffer, offset) {
                const view = new DataView(buffer);
                return view.getUint32(offset, false);
            }

            readUInt16BE(buffer, offset) {
                const view = new DataView(buffer);
                return view.getUint16(offset, false);
            }
        }

        // 初始化弹幕提取器
        const danmuExtractor = new DanmuExtractor();

        // 监听弹幕消息
        danmuExtractor.on('MsgData', (content) => {
            console.log("接收到的数据",content)
            if (content.cmd === 'DANMU_MSG') {
                const userUID = content.info[2][0];
                const userName = content.info[2][1];
                const message = content.info[1];
                addDanmuToUI(userName, userUID, message);
            }

        });

        // 获取真实房间号
        async function getRoomId(shortId) {
            try {
                const response = await fetch(`https://api.live.bilibili.com/room/v1/Room/room_init?id=${shortId}`);
                const data = await response.json();
                console.log("获取真实房间号", data.data.room_id);
                return data.data.room_id;
            } catch (error) {
                throw new Error('获取房间信息失败: ' + error.message);
            }
        }

        // 获取消息流服务器和密钥
        async function getDanmuInfo(roomId) {
            try {
                const response = await fetch(`https://workers.laplace.cn/bilibili/room-conn-info/${roomId}`); 
                const data = await response.json();
                console.log("获取消息流服务器和密钥", data.data);
                return data.data;
            } catch (error) {
                throw new Error('获取弹幕服务器信息失败: ' + error.message);
            }
        }

        // 生成鉴权包
        function generateCertificate(roomId, token) {
            const headerLength = 16;
            const protocol = 1;
            const type = 7;
            const sequence = 2;
            const body = JSON.stringify({
                uid: 0,
                roomid: roomId,
                protover: 2,
                buvid: '',
                platform: 'web',
                type: 2,
                key: token,
            });

            const bodyBytes = new TextEncoder().encode(body);
            const headerBuffer = new ArrayBuffer(headerLength);
            const headerView = new DataView(headerBuffer);
            
            headerView.setUint32(0, headerLength + bodyBytes.length, false);
            headerView.setUint16(4, headerLength, false);
            headerView.setUint16(6, protocol, false);
            headerView.setUint32(8, type, false);
            headerView.setUint32(12, sequence, false);

            const result = new Uint8Array(headerLength + bodyBytes.length);
            result.set(new Uint8Array(headerBuffer), 0);
            result.set(bodyBytes, headerLength);

            return result.buffer;
        }

        // 生成心跳包
        function generateHeartbeat() {
            const headerLength = 16;
            const protocol = 1;
            const type = 2;
            const sequence = 2;
            const body = '[Object object]';

            const bodyBytes = new TextEncoder().encode(body);
            const headerBuffer = new ArrayBuffer(headerLength);
            const headerView = new DataView(headerBuffer);
            
            headerView.setUint32(0, headerLength + bodyBytes.length, false);
            headerView.setUint16(4, headerLength, false);
            headerView.setUint16(6, protocol, false);
            headerView.setUint32(8, type, false);
            headerView.setUint32(12, sequence, false);

            const result = new Uint8Array(headerLength + bodyBytes.length);
            result.set(new Uint8Array(headerBuffer), 0);
            result.set(bodyBytes, headerLength);

            return result.buffer;
        }

        // 连接到直播间
        async function connectToRoom() {
            const roomIdInput = document.getElementById('roomId');
            const shortId = roomIdInput.value.trim();
            
            if (!shortId) {
                showStatus('请输入房间号', 'error');
                return;
            }

            try {
                showStatus('正在连接...', 'connecting');
                document.getElementById('connectBtn').disabled = true;

                const roomId = await getRoomId(shortId);
                const danmuInfo = await getDanmuInfo(roomId);
                
                const wsUrl = `wss://${danmuInfo.host_list[0].host}:${danmuInfo.host_list[0].wss_port}/sub`;
                console.log("WebSocket地址:", wsUrl);

                ws = new WebSocket(wsUrl);
                ws.binaryType = 'arraybuffer';

                ws.onopen = () => {
                    console.log('WebSocket 连接成功');
                    showStatus('连接成功', 'connected');
                    document.getElementById('disconnectBtn').disabled = false;
                    
                    // 发送认证包
                    const certificate = generateCertificate(roomId, danmuInfo.token);
                    ws.send(certificate);
                    
                    // 开始心跳
                    heartbeatInterval = setInterval(() => {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(generateHeartbeat());
                        }
                    }, 30000);
                };

                ws.onmessage = (event) => {
                    danmuExtractor.getDmMsg(event.data);
                };

                ws.onerror = (error) => {
                    console.error('WebSocket 错误:', error);
                    showStatus('连接错误', 'error');
                };

                ws.onclose = () => {
                    console.log('WebSocket 连接关闭');
                    showStatus('连接已断开', 'error');
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    
                    if (heartbeatInterval) {
                        clearInterval(heartbeatInterval);
                        heartbeatInterval = null;
                    }
                };

            } catch (error) {
                console.error('连接失败:', error);
                showStatus('连接失败: ' + error.message, 'error');
                document.getElementById('connectBtn').disabled = false;
            }
        }

        // 断开连接
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        // 显示状态
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
        }

        // 添加弹幕到UI
        function addDanmuToUI(userName, uid, content) {
            const container = document.getElementById('danmuContainer');
            const danmuItem = document.createElement('div');
            danmuItem.className = 'danmu-item';
            
            danmuItem.innerHTML = `
                <div class="danmu-user">${userName} (UID: ${uid})</div>
                <div class="danmu-content">${content}</div>
            `;
            
            container.appendChild(danmuItem);
            container.scrollTop = container.scrollHeight;
            
            // 限制显示的弹幕数量，避免页面卡顿
            if (container.children.length > 100) {
                container.removeChild(container.firstChild);
            }
        }

        // 页面关闭时断开连接
        window.addEventListener('beforeunload', () => {
            disconnect();
        });

        // 回车键连接
        document.getElementById('roomId').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                connectToRoom();
            }
        });
    </script>
</body>
</html>